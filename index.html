<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tuscany July Trip — Map • Itinerary • Budget</title>

  <!-- Leaflet (Map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Chart.js (Budget charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111824;
      --panel2:#0f1620;
      --text:#e9eef6;
      --muted:#a8b3c7;
      --accent:#5cc8ff;
      --good:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --route:#e11d48;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(92,200,255,.14), transparent 60%),
        radial-gradient(1000px 700px at 90% 30%, rgba(74,222,128,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    header{
      padding:22px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      font-weight:800;
    }

    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:75ch;
    }

    .pill{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill > span{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }

    .tabs{
      max-width:1200px;
      margin:10px auto 0;
      padding:0 18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .tabbtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      box-shadow: var(--shadow);
    }

    .tabbtn.active{
      border-color: rgba(92,200,255,.45);
      background: rgba(92,200,255,.16);
      color: var(--text);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:12px 18px 30px;
    }

    .page{ display:none; }
    .page.active{ display:block; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .card .hd h2{
      margin:0;
      font-size:14px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .card .hd small{ color:var(--muted); }

    .card .bd{ padding:14px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .metric{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius2);
      padding:12px;
    }

    .metric .k{
      color:var(--muted);
      font-size:11px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    .metric .v{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .metric .hint{
      margin-top:6px;
      color:var(--muted);
      font-size:11px;
      line-height:1.3;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    input[type="number"], input[type="text"], input[type="datetime-local"], input[type="date"], select{
      width:100%;
      background: rgba(0,0,0,.20);
      color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }

    input:focus, select:focus{ border-color: rgba(92,200,255,.55); }

    .btn{
      appearance:none;
      border:none;
      background: rgba(92,200,255,.18);
      color: var(--text);
      border:1px solid rgba(92,200,255,.35);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }

    .btn.secondary{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.12);
      color: var(--muted);
      font-weight:700;
    }

    .btn.danger{
      background: rgba(251,113,133,.14);
      border:1px solid rgba(251,113,133,.32);
    }

    .btn:hover{ filter:brightness(1.08); }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
    }

    .table th, .table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    .table th{ text-align:left; color:var(--muted); font-weight:800; }
    .table tr:last-child td{ border-bottom:none; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:99px; display:inline-block; }

    #map{ height: 680px; width:100%; border-radius: var(--radius); overflow:hidden; }
    @media (max-width: 980px){ #map{ height: 520px; } }

    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .note{ color:var(--muted); font-size:12px; line-height:1.45; margin:0; }
    .small{ color:var(--muted); font-size:11px; line-height:1.35; margin:8px 0 0; }

    .split{ display:grid; grid-template-columns: 1fr; gap:10px; }

    canvas{ max-width:100%; }

    .footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 24px;
      color:var(--muted);
      font-size:11px;
    }

    .empty{
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px;
      color:var(--muted);
      background: rgba(0,0,0,.10);
    }

    .suggestion{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      font-size:12px;
      color:var(--text);
    }
    .suggestion:last-child{ border-bottom:none; }
    .suggestion:hover{ background: rgba(92,200,255,.12); }
    .suggestion small{ color: var(--muted); display:block; margin-top:4px; }

    /* Leaflet tweaks */
    .leaflet-control-attribution{ background: rgba(0,0,0,.35) !important; color: #cdd6e6 !important; }
    .leaflet-popup-content-wrapper{ border-radius: 14px; background: rgba(15,22,32,.98); color: var(--text); border:1px solid rgba(255,255,255,.12); }
    .leaflet-popup-tip{ background: rgba(15,22,32,.98); }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div>
        <h1>Tuscany July Trip — Map • Itinerary • Budget</h1>
        <p class="subtitle">
          6 nights starting and ending in Florence, optimized for wine + food, fewer crowds, and heat-smart timing.
          Budget works offline; map tiles + road routing require internet.
        </p>
      </div>
      <div class="pill">
        <span>Route: Florence → Chianti (2) → Val d’Orcia (2) → Bolgheri Coast (2) → Pisa stop → Florence</span>
        <span>Heat tip: tastings 10:00–12:30, beach/pool siesta 13:00–17:00</span>
      </div>
    </div>
  </header>

  <nav class="tabs" aria-label="Pages">
    <button class="tabbtn active" data-page="mapPage" type="button">Map</button>
    <button class="tabbtn" data-page="itineraryPage" type="button">Itinerary</button>
    <button class="tabbtn" data-page="budgetPage" type="button">Budget</button>
    <button class="tabbtn" data-page="postPage" type="button">Post-trip</button>
  </nav>

  <main>
    <!-- MAP PAGE -->
    <section id="mapPage" class="page active">
      <div class="card">
        <div class="hd">
          <h2>Map — bases + activities</h2>
          <small>click markers for notes</small>
        </div>
        <div class="bd" style="padding:14px 14px 10px;">
          <div id="map"></div>
          <div class="legend">
            <span class="badge"><span class="dot" style="background:var(--accent)"></span>Base (overnight)</span>
            <span class="badge"><span class="dot" style="background:var(--good)"></span>Activities (recommended area)</span>
            <span class="badge"><span class="dot" style="background:var(--warn)"></span>Quick stop</span>
            <span class="badge"><span class="dot" style="background:var(--route)"></span>Fastest road route</span>
          </div>
        </div>
        <div class="bd" style="padding-top:0;">
          <p class="note">
            The route line uses OSRM’s <strong>driving</strong> profile (fastest by default). If OSRM is unavailable, it falls back to a straight-line polyline.
          </p>
          <div class="metric" style="margin-top:12px;">
            <div class="k"><span>Add custom stops</span><span class="badge"><span class="dot" style="background:var(--good)"></span>Places</span></div>
            <div class="row" style="margin-top:10px;">
              <div style="flex:1; min-width:200px;">
                <label for="stopType">Stop type</label>
                <select id="stopType">
                  <option value="base">Base (changes route)</option>
                  <option value="activity">Activity (recommended area)</option>
                </select>
              </div>
              <div style="flex:2; min-width:240px; position:relative;">
                <label for="stopSearch">Search real places</label>
                <input id="stopSearch" type="text" placeholder="Start typing a hotel, restaurant, winery, or place" autocomplete="off" />
                <div id="stopSuggestions" class="card" style="position:absolute; left:0; right:0; top:66px; display:none; z-index:20; max-height:220px; overflow:auto;"></div>
              </div>
              <div style="flex:2; min-width:220px;">
                <label for="stopNote">Note (optional)</label>
                <input id="stopNote" type="text" placeholder="e.g., dinner reservation" />
              </div>
              <button class="btn" id="btnAddStop" type="button">Add stop</button>
            </div>
            <div class="row" style="justify-content:space-between; margin-top:10px;">
              <p class="small" style="margin:0;">Uses OpenStreetMap search; select a suggestion to add.</p>
              <button class="btn secondary" id="btnClearStops" type="button">Clear custom stops</button>
            </div>
            <div id="customStopsList" class="split" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ITINERARY PAGE -->
    <section id="itineraryPage" class="page">
      <div class="card">
        <div class="hd">
          <h2>Itinerary</h2>
          <small>add flight details below</small>
        </div>
        <div class="bd">
          <div class="grid2" style="margin-bottom:10px;">
            <div class="metric">
              <div class="k"><span>Outbound flight</span><span class="badge"><span class="dot" style="background:var(--accent)"></span>Flight</span></div>
              <div class="v" id="outboundSummary">Not set</div>
              <div class="hint">Saved locally in your browser. Click “Edit flights”.</div>
            </div>
            <div class="metric">
              <div class="k"><span>Return flight</span><span class="badge"><span class="dot" style="background:var(--accent)"></span>Flight</span></div>
              <div class="v" id="returnSummary">Not set</div>
              <div class="hint">You’re flying back from Florence.</div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <button class="btn secondary" id="btnToggleFlights" type="button">Edit flights</button>
            <button class="btn" id="btnSaveFlights" type="button" style="display:none;">Save flights</button>
          </div>

          <div id="flightInputs" class="split" style="display:none;">
            <div class="row">
              <div style="flex:1; min-width:220px;">
                <label for="outFrom">Outbound: From</label>
                <input id="outFrom" type="text" placeholder="e.g., CPH" />
              </div>
              <div style="flex:1; min-width:220px;">
                <label for="outTo">Outbound: To</label>
                <input id="outTo" type="text" placeholder="e.g., FLR" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1; min-width:260px;">
                <label for="outDepart">Outbound: Departure (local time)</label>
                <input id="outDepart" type="datetime-local" />
              </div>
              <div style="flex:1; min-width:260px;">
                <label for="outArrive">Outbound: Arrival (local time)</label>
                <input id="outArrive" type="datetime-local" />
              </div>
            </div>

            <div class="row">
              <div style="flex:1; min-width:220px;">
                <label for="retFrom">Return: From</label>
                <input id="retFrom" type="text" placeholder="e.g., FLR" />
              </div>
              <div style="flex:1; min-width:220px;">
                <label for="retTo">Return: To</label>
                <input id="retTo" type="text" placeholder="e.g., CPH" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1; min-width:260px;">
                <label for="retDepart">Return: Departure (local time)</label>
                <input id="retDepart" type="datetime-local" />
              </div>
              <div style="flex:1; min-width:260px;">
                <label for="retArrive">Return: Arrival (local time)</label>
                <input id="retArrive" type="datetime-local" />
              </div>
            </div>
          </div>

          <table class="table" aria-label="Itinerary" style="margin-top:10px;">
            <thead>
              <tr>
                <th style="width:90px;">Night</th>
                <th>Base</th>
                <th>Best timing (heat-smart)</th>
                <th>Food & wine focus</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>0</strong></td>
                <td><strong>Florence (arrival day)</strong></td>
                <td>Land → quick lunch → leave the city</td>
                <td>Get to Chianti before late afternoon heat</td>
              </tr>
              <tr>
                <td><strong>1–2</strong></td>
                <td><strong>Chianti Hills</strong><br><span class="small">(Greve / Panzano area)</span></td>
                <td>Arrive by late morning; tastings 10:00–12:30; sunset dinner</td>
                <td>Chianti Classico, butcher-forward meals, trattorias</td>
              </tr>
              <tr>
                <td><strong>3–4</strong></td>
                <td><strong>Val d’Orcia</strong><br><span class="small">(Monticchiello / near Pienza)</span></td>
                <td>Early viewpoints; siesta; late aperitivo</td>
                <td>Brunello day trip, pecorino, pici pasta, slow evenings</td>
              </tr>
              <tr>
                <td><strong>5–6</strong></td>
                <td><strong>Bolgheri Coast</strong><br><span class="small">(Bolgheri / Castagneto Carducci)</span></td>
                <td>Wine mornings; beach afternoons; seafood nights</td>
                <td>Bolgheri reds (“Super Tuscan” style), grilled fish, sea breeze</td>
              </tr>
              <tr>
                <td><strong>—</strong></td>
                <td><strong>Pisa</strong><br><span class="small">quick stop on the way back</span></td>
                <td>Before 10:30 or after 17:00</td>
                <td>Iconic tower photo + cathedral exterior, then drive to Florence airport</td>
              </tr>
            </tbody>
          </table>

          <p class="note" style="margin-top:10px;">
            Activity marker notes are intentionally “area-first” to avoid sending you to bus-stop wineries.
            Use them to pick small producers nearby (book the 10:00 slot) and keep afternoons free.
          </p>
        </div>
      </div>
    </section>

    <!-- BUDGET PAGE -->
    <section id="budgetPage" class="page">
      <div class="card">
        <div class="hd">
          <h2>Budget</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <small>starts empty</small>
            <button class="btn secondary" id="btnToggleBudget" type="button">Add / Edit</button>
          </div>
        </div>
        <div class="bd">
          <div class="grid2" style="margin-bottom:10px;">
            <div class="metric">
              <div class="k"><span>Total budget</span><span class="badge"><span class="dot" style="background:var(--accent)"></span>Plan</span></div>
              <div class="v" id="mTotal">€0</div>
              <div class="hint">Optional. Set a cap, then add planned items below.</div>
            </div>
            <div class="metric">
              <div class="k"><span>Remaining</span><span class="badge"><span class="dot" id="remainDot" style="background:var(--good)"></span><span id="remainLabel">On track</span></span></div>
              <div class="v" id="mRemaining">€0</div>
              <div class="hint">Total budget − planned items.</div>
            </div>
          </div>

          <!-- Hidden by default; use Add/Edit button to show -->
          <div class="split" id="budgetInputs" style="display:none;">
            <div class="row">
              <div style="flex:1; min-width:180px;">
                <label for="currency">Currency symbol</label>
                <input id="currency" type="text" value="€" maxlength="3" />
              </div>
              <div style="flex:1; min-width:180px;">
                <label for="budget">Total trip budget</label>
                <input id="budget" type="number" value="0" min="0" step="10" placeholder="0" />
              </div>
            </div>

            <div class="row">
              <div style="flex:1; min-width:180px;">
                <label for="people">People</label>
                <input id="people" type="number" value="2" min="1" step="1" />
              </div>
              <div style="flex:1; min-width:180px;">
                <label for="days">Trip days (incl. travel days)</label>
                <input id="days" type="number" value="7" min="1" step="1" />
              </div>
            </div>

            <div class="metric" style="margin-top:4px;">
              <div class="k"><span>Add a planned budget item</span><span class="badge"><span class="dot" style="background:var(--warn)"></span>Items</span></div>
              <div class="row" style="margin-top:10px;">
                <div style="flex:1; min-width:180px;">
                  <label for="bItemDate">Date (optional)</label>
                  <input id="bItemDate" type="date" />
                </div>
                <div style="flex:1; min-width:180px;">
                  <label for="bItemCat">Category</label>
                  <select id="bItemCat">
                    <option value="lodging">Lodging</option>
                    <option value="car">Car / fuel / tolls</option>
                    <option value="food">Food</option>
                    <option value="wine">Wine</option>
                    <option value="activities">Activities</option>
                    <option value="misc">Misc</option>
                  </select>
                </div>
                <div style="flex:1; min-width:220px;">
                  <label for="bItemNote">Note</label>
                  <input id="bItemNote" type="text" placeholder="e.g., agriturismo deposit" />
                </div>
                <div style="width:170px;">
                  <label for="bItemAmt">Amount</label>
                  <input id="bItemAmt" type="number" min="0" step="0.01" placeholder="0" />
                </div>
                <button class="btn" id="btnAddBudgetItem" type="button">Add item</button>
              </div>
              <div class="row" style="justify-content:space-between; margin-top:10px;">
                <button class="btn secondary" id="btnExport" type="button">Export budget JSON</button>
                <button class="btn danger" id="btnClearBudget" type="button">Clear all</button>
              </div>
              <p class="small" style="margin-top:8px;">All budget items are stored locally (localStorage). Nothing is prefilled.</p>
            </div>
          </div>

          <table class="table" aria-label="Planned budget items" style="margin-top:10px;">
            <thead>
              <tr>
                <th style="width:110px;">Date</th>
                <th style="width:160px;">Category</th>
                <th>Note</th>
                <th style="width:120px; text-align:right;">Amount</th>
                <th style="width:120px;">Action</th>
              </tr>
            </thead>
            <tbody id="budgetTbody"></tbody>
          </table>
          <div id="budgetEmpty" class="empty" style="margin-top:10px; display:none;">
            No budget items yet. Tap <strong>Add / Edit</strong> → <strong>Add item</strong>.
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div class="card" style="border-radius:14px;">
              <div class="hd">
                <h2 style="font-size:13px;">Spend breakdown</h2>
                <small>planned items</small>
              </div>
              <div class="bd">
                <canvas id="pie"></canvas>
              </div>
            </div>
            <div class="card" style="border-radius:14px;">
              <div class="hd">
                <h2 style="font-size:13px;">Daily pace</h2>
                <small>per person</small>
              </div>
              <div class="bd">
                <canvas id="bar"></canvas>
              </div>
            </div>
          </div>

          <div class="metric" style="margin-top:10px;">
            <div class="k"><span>Suggested daily target</span><span class="badge"><span class="dot" style="background:var(--warn)"></span>Guide</span></div>
            <div class="v" id="mDaily">€0</div>
            <div class="hint">Based on planned items ÷ days and per-person estimate.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- POST-TRIP PAGE -->
    <section id="postPage" class="page">
      <div class="card">
        <div class="hd">
          <h2>Post-trip budget (actuals)</h2>
          <small>compare planned vs actual</small>
        </div>
        <div class="bd">
          <div class="grid2" style="margin-bottom:10px;">
            <div class="metric">
              <div class="k"><span>Planned spend</span><span class="badge"><span class="dot" style="background:var(--accent)"></span>Plan</span></div>
              <div class="v" id="plannedSpend">€0</div>
              <div class="hint">Sum of your planned budget items.</div>
            </div>
            <div class="metric">
              <div class="k"><span>Actual spend</span><span class="badge"><span class="dot" style="background:var(--good)"></span>Actual</span></div>
              <div class="v" id="actualSpend">€0</div>
              <div class="hint">Enter your real spending per category below.</div>
            </div>
          </div>

          <div class="metric" style="margin-bottom:10px;">
            <div class="k"><span>Variance (actual − planned)</span><span class="badge"><span class="dot" id="varDot" style="background:var(--good)"></span><span id="varLabel">On track</span></span></div>
            <div class="v" id="variance">€0</div>
            <div class="hint">Positive = over plan. Negative = under plan.</div>
          </div>

          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <button class="btn secondary" id="btnToggleActuals" type="button">Enter actuals</button>
            <button class="btn" id="btnResetActuals" type="button" style="display:none;">Reset actuals</button>
          </div>

          <div id="actualInputs" class="split" style="display:none;">
            <div class="row">
              <div style="flex:1; min-width:180px;">
                <label for="aLodging">Actual lodging</label>
                <input id="aLodging" type="number" min="0" step="10" value="0" />
              </div>
              <div style="flex:1; min-width:180px;">
                <label for="aCar">Actual car + fuel + tolls</label>
                <input id="aCar" type="number" min="0" step="10" value="0" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1; min-width:180px;">
                <label for="aFood">Actual food</label>
                <input id="aFood" type="number" min="0" step="10" value="0" />
              </div>
              <div style="flex:1; min-width:180px;">
                <label for="aWine">Actual wine</label>
                <input id="aWine" type="number" min="0" step="10" value="0" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1; min-width:180px;">
                <label for="aActivities">Actual activities</label>
                <input id="aActivities" type="number" min="0" step="10" value="0" />
              </div>
              <div style="flex:1; min-width:180px;">
                <label for="aBuffer">Actual misc</label>
                <input id="aBuffer" type="number" min="0" step="10" value="0" />
              </div>
            </div>
          </div>

          <table class="table" aria-label="Budget comparison" style="margin-top:10px;">
            <thead>
              <tr>
                <th>Category</th>
                <th style="width:120px;">Planned</th>
                <th style="width:120px;">Actual</th>
                <th style="width:120px;">Δ</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Lodging</td><td id="pLodging">—</td><td id="tLodging">—</td><td id="dLodging">—</td></tr>
              <tr><td>Car</td><td id="pCar">—</td><td id="tCar">—</td><td id="dCar">—</td></tr>
              <tr><td>Food</td><td id="pFood">—</td><td id="tFood">—</td><td id="dFood">—</td></tr>
              <tr><td>Wine</td><td id="pWine">—</td><td id="tWine">—</td><td id="dWine">—</td></tr>
              <tr><td>Activities</td><td id="pActivities">—</td><td id="tActivities">—</td><td id="dActivities">—</td></tr>
              <tr><td>Misc</td><td id="pBuffer">—</td><td id="tBuffer">—</td><td id="dBuffer">—</td></tr>
            </tbody>
          </table>

          <p class="small">
            Planned values come from your budget items. Actuals are stored locally in your browser.
          </p>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    <p class="note">
      Privacy: everything is local in your browser (localStorage). Map tiles and routing use public services (OpenStreetMap + OSRM).
    </p>
  </div>

  <script>
    // ---------------- Tabs ----------------
    function setActivePage(pageId){
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
      const page = document.getElementById(pageId);
      if (page) page.classList.add('active');
      const btn = document.querySelector(`.tabbtn[data-page="${pageId}"]`);
      if (btn) btn.classList.add('active');

      if (pageId === 'mapPage' && window.__tripMap){
        setTimeout(() => {
          window.__tripMap.invalidateSize();
          if (window.__tripMapLastBounds) window.__tripMap.fitBounds(window.__tripMapLastBounds);
        }, 60);
      }
    }

    document.querySelectorAll('.tabbtn').forEach(btn => {
      btn.addEventListener('click', () => setActivePage(btn.dataset.page));
    });

    // ---------- Budget plan model (starts empty) ----------
    const BUDGET_KEY_V2 = 'tuscanyTripBudgetPlanV2';

    const CATEGORY_LABELS = {
      lodging: 'Lodging',
      car: 'Car / fuel / tolls',
      food: 'Food',
      wine: 'Wine',
      activities: 'Activities',
      misc: 'Misc'
    };

    const BUDGET_DEFAULT_V2 = {
      currency: '€',
      totalBudget: 0,
      people: 2,
      days: 7,
      items: []
    };

    const els = {
      // Budget settings
      currency: document.getElementById('currency'),
      budget: document.getElementById('budget'),
      people: document.getElementById('people'),
      days: document.getElementById('days'),

      // Budget summary
      mTotal: document.getElementById('mTotal'),
      mRemaining: document.getElementById('mRemaining'),
      mDaily: document.getElementById('mDaily'),
      remainDot: document.getElementById('remainDot'),
      remainLabel: document.getElementById('remainLabel'),

      // Budget editor
      btnToggleBudget: document.getElementById('btnToggleBudget'),
      budgetInputs: document.getElementById('budgetInputs'),
      btnExport: document.getElementById('btnExport'),
      btnClearBudget: document.getElementById('btnClearBudget'),
      bItemDate: document.getElementById('bItemDate'),
      bItemCat: document.getElementById('bItemCat'),
      bItemNote: document.getElementById('bItemNote'),
      bItemAmt: document.getElementById('bItemAmt'),
      btnAddBudgetItem: document.getElementById('btnAddBudgetItem'),
      budgetTbody: document.getElementById('budgetTbody'),
      budgetEmpty: document.getElementById('budgetEmpty'),

      // Charts
      pie: document.getElementById('pie'),
      bar: document.getElementById('bar'),

      // Post-trip actuals
      plannedSpend: document.getElementById('plannedSpend'),
      actualSpend: document.getElementById('actualSpend'),
      variance: document.getElementById('variance'),
      varDot: document.getElementById('varDot'),
      varLabel: document.getElementById('varLabel'),
      btnToggleActuals: document.getElementById('btnToggleActuals'),
      btnResetActuals: document.getElementById('btnResetActuals'),
      actualInputs: document.getElementById('actualInputs'),
      aLodging: document.getElementById('aLodging'),
      aCar: document.getElementById('aCar'),
      aFood: document.getElementById('aFood'),
      aWine: document.getElementById('aWine'),
      aActivities: document.getElementById('aActivities'),
      aBuffer: document.getElementById('aBuffer'),

      pLodging: document.getElementById('pLodging'),
      pCar: document.getElementById('pCar'),
      pFood: document.getElementById('pFood'),
      pWine: document.getElementById('pWine'),
      pActivities: document.getElementById('pActivities'),
      pBuffer: document.getElementById('pBuffer'),

      tLodging: document.getElementById('tLodging'),
      tCar: document.getElementById('tCar'),
      tFood: document.getElementById('tFood'),
      tWine: document.getElementById('tWine'),
      tActivities: document.getElementById('tActivities'),
      tBuffer: document.getElementById('tBuffer'),

      dLodging: document.getElementById('dLodging'),
      dCar: document.getElementById('dCar'),
      dFood: document.getElementById('dFood'),
      dWine: document.getElementById('dWine'),
      dActivities: document.getElementById('dActivities'),
      dBuffer: document.getElementById('dBuffer'),

      // Flights
      btnToggleFlights: document.getElementById('btnToggleFlights'),
      btnSaveFlights: document.getElementById('btnSaveFlights'),
      flightInputs: document.getElementById('flightInputs'),
      outboundSummary: document.getElementById('outboundSummary'),
      returnSummary: document.getElementById('returnSummary'),
      outFrom: document.getElementById('outFrom'),
      outTo: document.getElementById('outTo'),
      outDepart: document.getElementById('outDepart'),
      outArrive: document.getElementById('outArrive'),
      retFrom: document.getElementById('retFrom'),
      retTo: document.getElementById('retTo'),
      retDepart: document.getElementById('retDepart'),
      retArrive: document.getElementById('retArrive'),

      // Custom stops
      stopType: document.getElementById('stopType'),
      stopSearch: document.getElementById('stopSearch'),
      stopSuggestions: document.getElementById('stopSuggestions'),
      stopNote: document.getElementById('stopNote'),
      btnAddStop: document.getElementById('btnAddStop'),
      btnClearStops: document.getElementById('btnClearStops'),
      customStopsList: document.getElementById('customStopsList')
    };

    function clampNumber(n){
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, n);
    }

    function fmt(cur, n){
      const v = Math.round(n);
      const sign = v < 0 ? '-' : '';
      return `${sign}${cur}${Math.abs(v).toLocaleString(undefined)}`;
    }

    function statusForRemaining(remaining){
      if (remaining >= 0) return { dot: 'var(--good)', label: 'On track' };
      if (remaining >= -75) return { dot: 'var(--warn)', label: 'Tight' };
      return { dot: 'var(--bad)', label: 'Over' };
    }

    function statusColorForDelta(delta){
      if (delta <= 0) return { dot: 'var(--good)', label: 'On/under plan' };
      if (delta <= 75) return { dot: 'var(--warn)', label: 'Slightly over' };
      return { dot: 'var(--bad)', label: 'Over plan' };
    }

    function loadBudgetV2(){
      try{
        const raw = localStorage.getItem(BUDGET_KEY_V2);
        if (!raw) return structuredClone(BUDGET_DEFAULT_V2);
        const parsed = JSON.parse(raw);
        const v = { ...BUDGET_DEFAULT_V2, ...parsed };
        if (!Array.isArray(v.items)) v.items = [];
        return v;
      }catch{
        return structuredClone(BUDGET_DEFAULT_V2);
      }
    }

    function saveBudgetV2(model){
      localStorage.setItem(BUDGET_KEY_V2, JSON.stringify(model));
    }

    function writeBudgetSettings(model){
      els.currency.value = model.currency || '€';
      els.budget.value = clampNumber(Number(model.totalBudget || 0));
      els.people.value = Math.max(1, Math.floor(Number(model.people || 2)));
      els.days.value = Math.max(1, Math.floor(Number(model.days || 7)));
    }

    function readBudgetSettings(model){
      const currency = (els.currency.value || '€').trim() || '€';
      const totalBudget = clampNumber(Number(els.budget.value));
      const people = Math.max(1, Math.floor(Number(els.people.value || 1)));
      const days = Math.max(1, Math.floor(Number(els.days.value || 1)));
      return { ...model, currency, totalBudget, people, days };
    }

    function sumsByCategory(items){
      const sums = { lodging:0, car:0, food:0, wine:0, activities:0, misc:0 };
      items.forEach(it => {
        const k = it.category;
        if (Object.prototype.hasOwnProperty.call(sums, k)) sums[k] += (Number(it.amount) || 0);
        else sums.misc += (Number(it.amount) || 0);
      });
      return sums;
    }

    function sumPlanned(items){
      return items.reduce((a, it) => a + (Number(it.amount) || 0), 0);
    }

    // ---------- Charts ----------
    let pieChart, barChart;

    function makeCharts(){
      pieChart = new Chart(els.pie, {
        type: 'doughnut',
        data: {
          labels: ['Lodging', 'Car', 'Food', 'Wine', 'Activities', 'Misc'],
          datasets: [{ data: [0,0,0,0,0,0] }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#cdd6e6', boxWidth: 10, boxHeight: 10 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const cur = currentBudget.currency;
                  return ` ${ctx.label}: ${fmt(cur, ctx.parsed)}`;
                }
              }
            }
          },
          cutout: '64%'
        }
      });

      barChart = new Chart(els.bar, {
        type: 'bar',
        data: {
          labels: ['Total/day', 'Per person/day'],
          datasets: [{ label: 'Budget pace', data: [0,0] }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => fmt(currentBudget.currency, ctx.parsed.y)
              }
            }
          },
          scales: {
            x: { ticks: { color: '#cdd6e6' }, grid: { color: 'rgba(255,255,255,.06)'} },
            y: { ticks: { color: '#cdd6e6' }, grid: { color: 'rgba(255,255,255,.06)'} }
          }
        }
      });
    }

    // ---------- Post-trip actuals ----------
    const ACTUALS_KEY = 'tuscanyTripActuals';
    const ACTUALS_DEFAULTS = { lodging: 0, car: 0, food: 0, wine: 0, activities: 0, buffer: 0 };

    function loadActuals(){
      try{
        const raw = localStorage.getItem(ACTUALS_KEY);
        if (!raw) return structuredClone(ACTUALS_DEFAULTS);
        const a = JSON.parse(raw);
        return { ...ACTUALS_DEFAULTS, ...a };
      }catch{
        return structuredClone(ACTUALS_DEFAULTS);
      }
    }

    function readActuals(){
      return {
        lodging: clampNumber(Number(els.aLodging.value)),
        car: clampNumber(Number(els.aCar.value)),
        food: clampNumber(Number(els.aFood.value)),
        wine: clampNumber(Number(els.aWine.value)),
        activities: clampNumber(Number(els.aActivities.value)),
        buffer: clampNumber(Number(els.aBuffer.value))
      };
    }

    function writeActuals(a){
      els.aLodging.value = a.lodging;
      els.aCar.value = a.car;
      els.aFood.value = a.food;
      els.aWine.value = a.wine;
      els.aActivities.value = a.activities;
      els.aBuffer.value = a.buffer;
    }

    function sumActuals(a){
      return a.lodging + a.car + a.food + a.wine + a.activities + a.buffer;
    }

    function updatePostTrip(){
      const cur = currentBudget.currency;
      const plannedSums = sumsByCategory(currentBudget.items);
      const planned = sumPlanned(currentBudget.items);
      const a = readActuals();
      const actual = sumActuals(a);
      const delta = actual - planned;

      els.plannedSpend.textContent = fmt(cur, planned);
      els.actualSpend.textContent = fmt(cur, actual);
      els.variance.textContent = fmt(cur, delta);

      const st = statusColorForDelta(delta);
      els.varDot.style.background = st.dot;
      els.varLabel.textContent = st.label;

      const setRow = (pEl, tEl, dEl, pVal, tVal) => {
        pEl.textContent = fmt(cur, pVal);
        tEl.textContent = fmt(cur, tVal);
        dEl.textContent = fmt(cur, tVal - pVal);
      };

      setRow(els.pLodging, els.tLodging, els.dLodging, plannedSums.lodging, a.lodging);
      setRow(els.pCar, els.tCar, els.dCar, plannedSums.car, a.car);
      setRow(els.pFood, els.tFood, els.dFood, plannedSums.food, a.food);
      setRow(els.pWine, els.tWine, els.dWine, plannedSums.wine, a.wine);
      setRow(els.pActivities, els.tActivities, els.dActivities, plannedSums.activities, a.activities);
      // misc planned maps to buffer actual
      setRow(els.pBuffer, els.tBuffer, els.dBuffer, plannedSums.misc, a.buffer);

      localStorage.setItem(ACTUALS_KEY, JSON.stringify(a));
    }

    // ---------- Budget UI ----------
    let currentBudget = loadBudgetV2();

    function renderBudgetItems(){
      els.budgetTbody.textContent = '';
      const items = [...currentBudget.items].sort((a,b) => (b.date || '').localeCompare(a.date || '') || (b.id - a.id));
      const fragment = document.createDocumentFragment();

      items.forEach(it => {
        const tr = document.createElement('tr');
        const date = it.date || '—';
        const cat = CATEGORY_LABELS[it.category] || it.category || '—';
        const note = (it.note || '').trim();
        const amt = fmt(currentBudget.currency, Number(it.amount) || 0);

        const dateTd = document.createElement('td');
        dateTd.textContent = date;

        const catTd = document.createElement('td');
        catTd.textContent = cat;

        const noteTd = document.createElement('td');
        if (note){
          noteTd.textContent = note;
        }else{
          const emptyNote = document.createElement('span');
          emptyNote.textContent = '—';
          emptyNote.style.color = 'rgba(168,179,199,.75)';
          noteTd.appendChild(emptyNote);
        }

        const amtTd = document.createElement('td');
        amtTd.textContent = amt;
        amtTd.style.textAlign = 'right';
        amtTd.style.fontWeight = '800';

        const btnTd = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.className = 'btn danger';
        delBtn.type = 'button';
        delBtn.dataset.del = String(it.id);
        delBtn.textContent = 'Delete';
        btnTd.appendChild(delBtn);

        tr.appendChild(dateTd);
        tr.appendChild(catTd);
        tr.appendChild(noteTd);
        tr.appendChild(amtTd);
        tr.appendChild(btnTd);
        fragment.appendChild(tr);
      });

      els.budgetTbody.appendChild(fragment);

      const empty = currentBudget.items.length === 0;
      els.budgetEmpty.style.display = empty ? 'block' : 'none';

    }

    function updateBudgetUI(){
      // sync settings fields into model
      currentBudget = readBudgetSettings(currentBudget);
      saveBudgetV2(currentBudget);

      const cur = currentBudget.currency;
      const planned = sumPlanned(currentBudget.items);
      const remaining = currentBudget.totalBudget - planned;

      els.mTotal.textContent = fmt(cur, currentBudget.totalBudget);
      els.mRemaining.textContent = fmt(cur, remaining);

      const st = statusForRemaining(remaining);
      els.remainDot.style.background = st.dot;
      els.remainLabel.textContent = st.label;

      const perDay = currentBudget.days > 0 ? (planned / currentBudget.days) : 0;
      const perPersonPerDay = currentBudget.people > 0 ? (perDay / currentBudget.people) : 0;
      els.mDaily.textContent = `${fmt(cur, perDay)} / day  •  ${fmt(cur, perPersonPerDay)} pp/day`;

      const sums = sumsByCategory(currentBudget.items);

      if (pieChart && barChart){
        pieChart.data.datasets[0].data = [sums.lodging, sums.car, sums.food, sums.wine, sums.activities, sums.misc];
        pieChart.update();
        barChart.data.datasets[0].data = [perDay, perPersonPerDay];
        barChart.update();
      }

      updatePostTrip();
    }

    function wireBudgetEvents(){
      // Toggle editor
      els.btnToggleBudget.addEventListener('click', () => {
        const open = els.budgetInputs.style.display !== 'none';
        els.budgetInputs.style.display = open ? 'none' : 'grid';
        els.btnToggleBudget.textContent = open ? 'Add / Edit' : 'Hide';
      });

      // hidden by default
      els.budgetInputs.style.display = 'none';
      els.btnToggleBudget.textContent = 'Add / Edit';

      // Save-on-change for settings
      [els.currency, els.budget, els.people, els.days].forEach(inp => {
        inp.addEventListener('input', () => updateBudgetUI());
      });

      // Add item
      els.btnAddBudgetItem.addEventListener('click', () => {
        const amount = Number(els.bItemAmt.value);
        if (!Number.isFinite(amount) || amount <= 0){
          alert('Please enter a valid amount.');
          return;
        }
        const item = {
          id: Date.now(),
          date: (els.bItemDate.value || '').trim(),
          category: els.bItemCat.value,
          note: (els.bItemNote.value || '').trim(),
          amount: Math.round(amount * 100) / 100
        };
        currentBudget.items.push(item);
        saveBudgetV2(currentBudget);
        els.bItemAmt.value = '';
        els.bItemNote.value = '';
        renderBudgetItems();
        updateBudgetUI();
      });

      els.budgetTbody.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-del]');
        if (!btn || !els.budgetTbody.contains(btn)) return;
        const id = Number(btn.dataset.del);
        currentBudget.items = currentBudget.items.filter(x => x.id !== id);
        saveBudgetV2(currentBudget);
        renderBudgetItems();
        updateBudgetUI();
      });

      // Export
      els.btnExport.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(currentBudget, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tuscany-trip-budget.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // Clear
      els.btnClearBudget.addEventListener('click', () => {
        if (!confirm('Clear all budget items and reset budget settings?')) return;
        currentBudget = structuredClone(BUDGET_DEFAULT_V2);
        saveBudgetV2(currentBudget);
        writeBudgetSettings(currentBudget);
        renderBudgetItems();
        updateBudgetUI();
      });

      // Post-trip
      [els.aLodging, els.aCar, els.aFood, els.aWine, els.aActivities, els.aBuffer].forEach(inp => {
        inp.addEventListener('input', updatePostTrip);
      });

      els.btnToggleActuals.addEventListener('click', () => {
        const open = els.actualInputs.style.display !== 'none';
        els.actualInputs.style.display = open ? 'none' : 'grid';
        els.btnToggleActuals.textContent = open ? 'Enter actuals' : 'Hide actuals';
        els.btnResetActuals.style.display = open ? 'none' : 'inline-flex';
      });

      els.btnResetActuals.addEventListener('click', () => {
        writeActuals(structuredClone(ACTUALS_DEFAULTS));
        updatePostTrip();
      });

      // Flights
      els.btnToggleFlights.addEventListener('click', () => {
        const open = els.flightInputs.style.display !== 'none';
        els.flightInputs.style.display = open ? 'none' : 'grid';
        els.btnSaveFlights.style.display = open ? 'none' : 'inline-flex';
        els.btnToggleFlights.textContent = open ? 'Edit flights' : 'Hide flight editor';
      });

      els.btnSaveFlights.addEventListener('click', () => {
        saveFlights();
        els.flightInputs.style.display = 'none';
        els.btnSaveFlights.style.display = 'none';
        els.btnToggleFlights.textContent = 'Edit flights';
      });
    }

    // ---------- Flights ----------
    const FLIGHT_DEFAULTS = {
      outFrom: '', outTo: 'FLR', outDepart: '', outArrive: '',
      retFrom: 'FLR', retTo: '', retDepart: '', retArrive: ''
    };

    function loadFlights(){
      try{
        const raw = localStorage.getItem('tuscanyTripFlights');
        if (!raw) return FLIGHT_DEFAULTS;
        const f = JSON.parse(raw);
        return { ...FLIGHT_DEFAULTS, ...f };
      }catch{
        return FLIGHT_DEFAULTS;
      }
    }

    function writeFlights(f){
      els.outFrom.value = f.outFrom;
      els.outTo.value = f.outTo;
      els.outDepart.value = f.outDepart;
      els.outArrive.value = f.outArrive;
      els.retFrom.value = f.retFrom;
      els.retTo.value = f.retTo;
      els.retDepart.value = f.retDepart;
      els.retArrive.value = f.retArrive;
    }

    function summarizeFlight(from, to, depart, arrive){
      const fmtDT = (v) => v ? new Date(v).toLocaleString(undefined, { dateStyle:'medium', timeStyle:'short' }) : '—';
      const legs = `${from || '—'} → ${to || '—'}`;
      return `${legs}  •  ${fmtDT(depart)} → ${fmtDT(arrive)}`;
    }

    function updateFlightSummaries(){
      const f = {
        outFrom: els.outFrom.value.trim(),
        outTo: els.outTo.value.trim(),
        outDepart: els.outDepart.value,
        outArrive: els.outArrive.value,
        retFrom: els.retFrom.value.trim(),
        retTo: els.retTo.value.trim(),
        retDepart: els.retDepart.value,
        retArrive: els.retArrive.value
      };

      els.outboundSummary.textContent = summarizeFlight(f.outFrom, f.outTo, f.outDepart, f.outArrive);
      els.returnSummary.textContent = summarizeFlight(f.retFrom, f.retTo, f.retDepart, f.retArrive);
    }

    function saveFlights(){
      const f = {
        outFrom: els.outFrom.value.trim(),
        outTo: els.outTo.value.trim(),
        outDepart: els.outDepart.value,
        outArrive: els.outArrive.value,
        retFrom: els.retFrom.value.trim(),
        retTo: els.retTo.value.trim(),
        retDepart: els.retDepart.value,
        retArrive: els.retArrive.value
      };
      localStorage.setItem('tuscanyTripFlights', JSON.stringify(f));
      updateFlightSummaries();

      if (window.__tripMap && window.__flightLayer){
        window.__flightLayer.clearLayers();
        addFlightMarkers(window.__flightLayer, f);
      }
    }

    // ---------- Map data (bases + activities) ----------
    const bases = [
      { name: 'Florence (start/end)', nights: '—', lat: 43.7696, lng: 11.2558, note: 'Land → leave the city quickly for cooler hills. Return for flight.' },
      { name: 'Chianti Hills (Greve / Panzano base)', nights: 'Nights 1–2', lat: 43.5852, lng: 11.3150, note: 'Choose an agriturismo at elevation; tastings in the morning.' },
      { name: 'Val d’Orcia (Monticchiello / near Pienza base)', nights: 'Nights 3–4', lat: 43.0676, lng: 11.6756, note: 'Quiet village base. Early views, siesta, long dinners.' },
      { name: 'Bolgheri Coast (Bolgheri / Castagneto Carducci base)', nights: 'Nights 5–6', lat: 43.2410, lng: 10.6110, note: 'Sea breeze nights; wine mornings + beach afternoons.' }
    ];

    const activitiesStops = [
      { name: 'Chianti Classico (Panzano area)', lat: 43.5428, lng: 11.3093, note: 'Look for small, appointment-only producers; avoid midday groups.' },
      { name: 'Radda / Gaiole high Chianti', lat: 43.4887, lng: 11.3734, note: 'Higher altitude → cooler. Great Sangiovese and calmer roads.' },
      { name: 'Brunello zone (north/east of Montalcino)', lat: 43.0575, lng: 11.4899, note: 'Book the 10:00 tasting. Stay outside town for fewer crowds.' },
      { name: 'Montepulciano (Vino Nobile area)', lat: 43.0932, lng: 11.7835, note: 'Optional half-day: tastings early; leave before the heat peak.' },
      { name: 'Bolgheri DOC (vineyard belt)', lat: 43.2465, lng: 10.5822, note: 'Go early, then beach. Seek smaller estates off the main lane.' }
    ];

    const quickStops = [
      { name: 'Pisa — Leaning Tower', lat: 43.7229, lng: 10.3966, note: '60–90 minutes. Best before 10:30 or after 17:00.' }
    ];

    const florenceAirport = { name: 'Florence Airport (FLR)', lat: 43.8100, lng: 11.2050, note: 'Aeroporto di Firenze-Peretola. Return your car here.' };
    const CUSTOM_STOPS_KEY = 'tuscanyTripCustomStops';
    const CUSTOM_STOPS_DEFAULTS = { bases: [], activities: [] };
    let customStops = loadCustomStops();

    const ROUTE_ANCHORS = [
      { id: 'florence-start', lat: 43.7696, lng: 11.2558 },
      { id: 'chianti', lat: 43.5852, lng: 11.3150 },
      { id: 'valdorcia', lat: 43.0676, lng: 11.6756 },
      { id: 'bolgheri', lat: 43.2410, lng: 10.6110 },
      { id: 'pisa', lat: 43.7229, lng: 10.3966 },
      { id: 'florence-end', lat: 43.7696, lng: 11.2558 }
    ];

    function loadCustomStops(){
      try{
        const raw = localStorage.getItem(CUSTOM_STOPS_KEY);
        if (!raw) return structuredClone(CUSTOM_STOPS_DEFAULTS);
        const parsed = JSON.parse(raw);
        return {
          bases: Array.isArray(parsed.bases) ? parsed.bases : [],
          activities: Array.isArray(parsed.activities) ? parsed.activities : []
        };
      }catch{
        return structuredClone(CUSTOM_STOPS_DEFAULTS);
      }
    }

    function saveCustomStops(model){
      localStorage.setItem(CUSTOM_STOPS_KEY, JSON.stringify(model));
    }

    function markerHtml(color){
      return `\
        <div style="\
          width:14px;height:14px;border-radius:999px;\
          background:${color};\
          box-shadow:0 0 0 4px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.35) inset;\
        "></div>`;
    }

    function makeDivIcon(color){
      return L.divIcon({
        className: 'custom-pin',
        html: markerHtml(color),
        iconSize: [14,14],
        iconAnchor: [7,7]
      });
    }

    function addFlightMarkers(layer, f){
      const flightIcon = makeDivIcon('var(--accent)');
      L.marker([florenceAirport.lat, florenceAirport.lng], { icon: flightIcon })
        .bindPopup(`<strong>${florenceAirport.name}</strong><br/><br/>${florenceAirport.note}`)
        .addTo(layer);

      if (f.outFrom || f.retTo){
        const label = `<strong>Flights</strong><br/><br/>Outbound: ${f.outFrom || '—'} → ${f.outTo || 'FLR'}<br/>Return: ${f.retFrom || 'FLR'} → ${f.retTo || '—'}`;
        L.marker([43.79, 11.23], { icon: flightIcon })
          .bindPopup(label)
          .addTo(layer);
      }
    }

    function buildRoutePoints(){
      const anchors = [...ROUTE_ANCHORS];
      const insertIndex = Math.max(0, anchors.findIndex(a => a.id === 'pisa'));
      const customBases = customStops.bases.map(b => ({ lat: b.lat, lng: b.lng }));
      const before = anchors.slice(0, insertIndex);
      const after = anchors.slice(insertIndex);
      return [...before, ...customBases, ...after].map(p => [p.lng, p.lat]);
    }

    function updateRoute(){
      const map = window.__tripMap;
      const layers = window.__tripMapLayers;
      if (!map || !layers) return;

      const { baseGroup, activityGroup, quickGroup, flightLayer } = layers;
      const routeStyle = { color: getComputedStyle(document.documentElement).getPropertyValue('--route').trim() || '#e11d48', weight: 5, opacity: 0.9 };
      const routePoints = buildRoutePoints();
      if (window.__routeLayer){
        map.removeLayer(window.__routeLayer);
        window.__routeLayer = null;
      }

      if (routePoints.length < 2) return;

      const coordString = routePoints.map(p => p.join(',')).join(';');
      const fitToLayers = (routeLayer) => {
        const all = L.featureGroup([baseGroup, activityGroup, quickGroup, flightLayer, routeLayer].filter(Boolean));
        if (all.getLayers().length){
          const b = all.getBounds().pad(0.18);
          map.fitBounds(b);
          window.__tripMapLastBounds = b;
        }
      };

      fetch(`https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson&alternatives=false&steps=false&annotations=false`)
        .then(r => r.json())
        .then(data => {
          if (data.routes && data.routes[0] && data.routes[0].geometry){
            window.__routeLayer = L.geoJSON(data.routes[0].geometry, routeStyle).addTo(map);
            fitToLayers(window.__routeLayer);
          }
        })
        .catch(() => {
          window.__routeLayer = L.polyline(routePoints.map(p => [p[1], p[0]]), {
            color: routeStyle.color,
            weight: 4,
            opacity: 0.5,
            dashArray:'6 8'
          }).addTo(map);
          fitToLayers(window.__routeLayer);
        });
    }

    function refreshMapLayers(){
      const map = window.__tripMap;
      const layers = window.__tripMapLayers;
      if (!map || !layers) return;

      const { baseGroup, activityGroup, quickGroup, flightLayer, baseIcon, activityIcon, quickIcon } = layers;
      baseGroup.clearLayers();
      activityGroup.clearLayers();
      quickGroup.clearLayers();
      flightLayer.clearLayers();

      bases.forEach(b => {
        L.marker([b.lat, b.lng], { icon: baseIcon })
          .bindPopup(`<strong>${b.name}</strong><br/><span style="color:rgba(233,238,246,.75)">${b.nights}</span><br/><br/>${b.note}`)
          .addTo(baseGroup);
      });

      customStops.bases.forEach(b => {
        const note = b.note ? `<br/><br/>${b.note}` : '';
        const meta = b.address ? `<br/><span style="color:rgba(233,238,246,.75)">${b.address}</span>` : '';
        L.marker([b.lat, b.lng], { icon: baseIcon })
          .bindPopup(`<strong>${b.name}</strong>${meta}${note}`)
          .addTo(baseGroup);
      });

      activitiesStops.forEach(w => {
        L.marker([w.lat, w.lng], { icon: activityIcon })
          .bindPopup(`<strong>${w.name}</strong><br/><br/>${w.note}`)
          .addTo(activityGroup);
      });

      customStops.activities.forEach(a => {
        const note = a.note ? `<br/><br/>${a.note}` : '';
        const meta = a.address ? `<br/><span style="color:rgba(233,238,246,.75)">${a.address}</span>` : '';
        L.marker([a.lat, a.lng], { icon: activityIcon })
          .bindPopup(`<strong>${a.name}</strong>${meta}${note}`)
          .addTo(activityGroup);
      });

      quickStops.forEach(q => {
        L.marker([q.lat, q.lng], { icon: quickIcon })
          .bindPopup(`<strong>${q.name}</strong><br/><br/>${q.note}`)
          .addTo(quickGroup);
      });

      addFlightMarkers(flightLayer, loadFlights());
      updateRoute();
    }

    function renderCustomStopsList(){
      els.customStopsList.textContent = '';
      const allStops = [
        ...customStops.bases.map(s => ({ ...s, type: 'base' })),
        ...customStops.activities.map(s => ({ ...s, type: 'activity' }))
      ];

      if (allStops.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No custom stops yet.';
        els.customStopsList.appendChild(empty);
        return;
      }

      allStops.forEach(stop => {
        const card = document.createElement('div');
        card.className = 'metric';
        card.dataset.stopId = String(stop.id);
        card.dataset.stopType = stop.type;

        const header = document.createElement('div');
        header.className = 'k';
        const typeLabel = stop.type === 'base' ? 'Base' : 'Activity';
        header.innerHTML = `<span>${typeLabel}</span><span class="badge"><span class="dot" style="background:${stop.type === 'base' ? 'var(--accent)' : 'var(--good)'}"></span>${typeLabel}</span>`;

        const title = document.createElement('div');
        title.className = 'v';
        title.textContent = stop.name;

        const meta = document.createElement('div');
        meta.className = 'hint';
        const note = stop.note ? ` • ${stop.note}` : '';
        meta.textContent = `${stop.address || 'Custom stop'}${note}`;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn danger';
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';

        card.appendChild(header);
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(removeBtn);
        els.customStopsList.appendChild(card);
      });
    }

    function formatSuggestion(place){
      const name = place.display_name ? place.display_name.split(',')[0] : place.name || 'Place';
      const address = place.display_name || '';
      return { name, address };
    }

    function renderStopSuggestions(list){
      els.stopSuggestions.textContent = '';
      if (list.length === 0){
        els.stopSuggestions.style.display = 'none';
        return;
      }
      list.forEach(place => {
        const { name, address } = formatSuggestion(place);
        const item = document.createElement('div');
        item.className = 'suggestion';
        item.textContent = name;
        const detail = document.createElement('small');
        detail.textContent = address;
        item.appendChild(detail);
        item.dataset.place = JSON.stringify({
          name,
          address,
          lat: Number(place.lat),
          lng: Number(place.lon)
        });
        els.stopSuggestions.appendChild(item);
      });
      els.stopSuggestions.style.display = 'block';
    }

    function wireCustomStops(){
      let debounceTimer = null;
      let searchController = null;
      let selectedPlace = null;

      const clearSuggestions = () => {
        els.stopSuggestions.style.display = 'none';
        els.stopSuggestions.textContent = '';
      };

      const searchPlaces = (query) => {
        if (searchController) searchController.abort();
        searchController = new AbortController();
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=6&addressdetails=1&countrycodes=it&q=${encodeURIComponent(query)}`;
        fetch(url, { signal: searchController.signal })
          .then(r => r.json())
          .then(results => renderStopSuggestions(Array.isArray(results) ? results : []))
          .catch(() => {
            clearSuggestions();
          });
      };

      els.stopSearch.addEventListener('input', () => {
        selectedPlace = null;
        const query = els.stopSearch.value.trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        if (query.length < 3){
          clearSuggestions();
          return;
        }
        debounceTimer = setTimeout(() => searchPlaces(query), 300);
      });

      els.stopSuggestions.addEventListener('click', (event) => {
        const item = event.target.closest('.suggestion');
        if (!item) return;
        const data = JSON.parse(item.dataset.place || '{}');
        selectedPlace = data;
        els.stopSearch.value = data.name || '';
        clearSuggestions();
      });

      document.addEventListener('click', (event) => {
        if (!els.stopSuggestions.contains(event.target) && event.target !== els.stopSearch){
          clearSuggestions();
        }
      });

      els.btnAddStop.addEventListener('click', () => {
        if (!selectedPlace || !Number.isFinite(selectedPlace.lat) || !Number.isFinite(selectedPlace.lng)){
          alert('Select a suggestion from the list before adding.');
          return;
        }
        const entry = {
          id: Date.now(),
          name: selectedPlace.name || els.stopSearch.value.trim() || 'Custom stop',
          address: selectedPlace.address || '',
          lat: selectedPlace.lat,
          lng: selectedPlace.lng,
          note: (els.stopNote.value || '').trim()
        };
        if (els.stopType.value === 'base'){
          customStops.bases.push(entry);
        }else{
          customStops.activities.push(entry);
        }
        saveCustomStops(customStops);
        renderCustomStopsList();
        refreshMapLayers();
        els.stopSearch.value = '';
        els.stopNote.value = '';
        selectedPlace = null;
      });

      els.btnClearStops.addEventListener('click', () => {
        if (!confirm('Clear all custom stops?')) return;
        customStops = structuredClone(CUSTOM_STOPS_DEFAULTS);
        saveCustomStops(customStops);
        renderCustomStopsList();
        refreshMapLayers();
      });

      els.customStopsList.addEventListener('click', (event) => {
        const removeBtn = event.target.closest('button');
        if (!removeBtn) return;
        const card = event.target.closest('[data-stop-id]');
        if (!card) return;
        const id = Number(card.dataset.stopId);
        const type = card.dataset.stopType;
        if (type === 'base'){
          customStops.bases = customStops.bases.filter(s => s.id !== id);
        }else{
          customStops.activities = customStops.activities.filter(s => s.id !== id);
        }
        saveCustomStops(customStops);
        renderCustomStopsList();
        refreshMapLayers();
      });

      renderCustomStopsList();
    }

    function initMap(){
      const map = L.map('map', { scrollWheelZoom: true });
      window.__tripMap = map;

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const baseIcon = makeDivIcon('var(--accent)');
      const activityIcon = makeDivIcon('var(--good)');
      const quickIcon = makeDivIcon('var(--warn)');

      const baseGroup = L.featureGroup();
      const activityGroup = L.featureGroup();
      const quickGroup = L.featureGroup();
      const flightLayer = L.featureGroup();
      window.__flightLayer = flightLayer;

      baseGroup.addTo(map);
      activityGroup.addTo(map);
      quickGroup.addTo(map);
      flightLayer.addTo(map);

      window.__tripMapLayers = {
        baseGroup,
        activityGroup,
        quickGroup,
        flightLayer,
        baseIcon,
        activityIcon,
        quickIcon
      };

      refreshMapLayers();

      L.control.layers(null, {
        'Bases (overnight)': baseGroup,
        'Activities': activityGroup,
        'Quick stops': quickGroup,
        'Flights (FLR)': flightLayer
      }, { collapsed: false }).addTo(map);
    }

    // ---------- Minimal self-tests (run in console) ----------
    function runSelfTests(){
      const assert = (cond, msg) => { if (!cond) throw new Error(`Self-test failed: ${msg}`); };
      assert(document.getElementById('map'), '#map exists');
      assert(document.getElementById('pie'), 'pie canvas exists');
      assert(document.getElementById('bar'), 'bar canvas exists');
      assert(document.getElementById('budgetTbody'), 'budget table body exists');
      assert(document.getElementById('budgetInputs').style.display === 'none', 'budget editor hidden by default');
      assert(Array.isArray(bases) && bases.length >= 3, 'bases array populated');
      assert(Array.isArray(activitiesStops) && activitiesStops.length >= 1, 'activitiesStops array populated');
      assert(document.querySelectorAll('.tabbtn').length >= 3, 'tabs exist');
      return true;
    }

    // ---------- Boot ----------
    (function(){
      // Load budget plan v2 (empty by default)
      currentBudget = loadBudgetV2();
      writeBudgetSettings(currentBudget);

      // Load actuals + flights
      writeActuals(loadActuals());
      const savedFlights = loadFlights();
      writeFlights(savedFlights);
      updateFlightSummaries();

      function ready(){ return window.Chart && window.L; }

      function start(){
        makeCharts();
        wireBudgetEvents();
        renderBudgetItems();
        updateBudgetUI();
        wireCustomStops();
        initMap();

        try{ runSelfTests(); }catch(e){ console.error(e); }
      }

      const t = setInterval(() => {
        if (ready()){
          clearInterval(t);
          start();
        }
      }, 40);

      setTimeout(() => {
        if (!ready()) console.warn('Libraries not loaded. Are you offline? Budget works; map + routing needs internet.');
      }, 3500);
    })();
  </script>
</body>
</html>
